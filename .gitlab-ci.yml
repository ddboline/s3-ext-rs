image: rust:latest

services:
- name: minio/minio
  command: ['server', '/minio']
  alias: minio

variables:
  RUST_BACKTRACE: '1'
  QUICKCHECK_GENERATOR_SIZE: 1572864
  S3_ENDPOINT: http://minio:9000

  # used by minio service
  MINIO_SECRET_KEY: TtnuieannGt2rGuie2t8Tt7urarg5nauedRndrur
  MINIO_ACCESS_KEY: ANTN35UAENTS5UIAEATD
  MINIO_DOMAIN: localhost

.job_template: &template
  script:
  - rustc --version && cargo --version
  - cargo rustc -- -D warnings
  - cargo test --all --verbose

test:stable:
  <<: *template

test:beta:
  <<: *template
  before_script:
  - rustup toolchain install beta
  - rustup default beta

test:nightly:
  <<: *template
  image: rustlang/rust:nightly
  services:
  - name: minio/minio:edge
    command: ['server', '/minio']
    alias: minio
  allow_failure: true

lint:nightly:
  image: rustlang/rust:nightly
  script:
  - rustc --version && cargo --version
  - rustup component add clippy-preview
  - cargo clippy -- -D clippy -D clippy_pedantic -D warnings
  allow_failure: true
